'use strict';


//┐  COMBA
//╠──███████████████████████████████████████████████████████████████████████████
//┘


	//┐  USAGE
	//╠──⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙
	//┘

		/*
			const { series, parallel } = require('comba');



			// TASK EXAMPLE
			// ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔

				function callback (ok)
				{
					// execution
					// ...

					ok(); // ok
				}



			// TASK LIST
			// ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔


				// CREATE TASKS (SYNC & ASYNC)
				// ─────────────────────────────────────────────────

					let sync = (n) => (done) => { console.log(n); done() },
						async = (n, t) => (done) => setTimeout(() => { console.log(n); done() }, t);


				// TASKS
				// ─────────────────────────────────────────────────

					let a = async('a', 2400),
						b = async('b', 1200),
						c = sync('c'),
						d = async('d', 2000),
						e = sync('e'),
						f = sync('f');



			// ON COMPLETE HANDLER
			// ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔

				const onCompleteHandler = () => console.log('on complete');



			// SERIES EXECUTION
			// ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔

				series(a, b, c, d, e, f).run(); // a › b › c › d › e › f
				series(a, b, c, d, e, f).run(onCompleteHandler); // a › b › c › d › e › f › on complete



			// PARALLEL EXECUTION
			// ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔

				parallel(a, b, c, d, e, f).run(); // c › e › f › b › d › a
				parallel(a, b, c, d, e, f).run(onCompleteHandler); // c › e › f › b › d › a › on complete

		*/



	//┐  DEFAULT OPTIONS
	//╠──⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙
	//┘

		const __default = Object.create(null);

		__default.parallel = false;
		__default.limit = 0;




//┐  CONSTRUCTOR
//╠──░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//┘


	function Comba (options, ...values)
	{
		options = Object.assign({}, __default, options || {});

		const ctx = Object.create(null);

		ctx.instance = this;
		ctx.parallel = options.parallel;
		ctx.limit = options.limit;
		ctx.commands = values;

		ctx.running = false;
		ctx.end = null;


		return Object.defineProperties(ctx.instance,
		{
			isRunning: { get: () => ctx.running },

			limit:
			{
				value: (value) =>
				{
					if (ctx.parallel && toString.call(value) === '[object Number]' &&  value > 0) {
						ctx.limit = value;
					}

					return ctx.instance;
				}
			},

			run:
			{
				value: (callback) =>
				{
					if (!ctx.running)
					{
						ctx.end = (toString.call(callback) === '[object Function]') ? callback : null;
						ctx.running = true;

						__exec(ctx);
					}

					else return null;
				}
			}
		});
	}




//┐  EXECUTION
//╠──░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//┘


	function __exec (ctx)
	{
		ctx.total = ctx.commands.length;
		ctx.pending = ctx.total;
		ctx.completed = 0;
		ctx.next = 0;

		if (ctx.parallel) {
			ctx.commands.forEach(command => __next(ctx));
		}

		else __next(ctx);
	}



	//┐  NEXT
	//╠──⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙
	//┘

		function __next (ctx)
		{
			ctx.next = ctx.total - ctx.pending;
			ctx.pending -= 1;

			const command = ctx.commands[ctx.next],

			done = (error) =>
			{
				ctx.completed += 1;

				if (ctx.total === ctx.completed || error) {
					return __complete(ctx, error);
				}

				if (!ctx.parallel) {
					return __next(ctx);
				}
			};


			command(done);
		}



	//┐  COMPLETE
	//╠──⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙
	//┘

		function __complete (ctx, error)
		{
			ctx.running = false;

			if (error) {
				throw new Error ('callback error ' + error);
			}

			if (ctx.end !== null) {
				ctx.end();
			}
		}




//┐  CONTEXT
//╠──░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//┘


	const __create = (options, ...values) => new Comba(options, ...values);



	//┐  SERIES EXECUTION
	//╠──⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙
	//┘

		const __series = (...values) => __create({ isParallel: false }, ...values);



	//┐  PARALLEL EXECUTION
	//╠──⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙
	//┘

		const __parallel = (...values) => __create({ isParallel: true }, ...values);




//┐  EXPORTS
//╠──░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//┘

	module.exports = { series: __series, parallel: __parallel };



'use strict';


//┐  COMBA LIST
//╠──███████████████████████████████████████████████████████████████████████████
//┘


	//┐  IMPORTS
	//╠──⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙
	//┘

		const
			CombaTask = require('./task'),
			CombaMill = require('./mill'),
			Make = require('./make'),
			Utils = require('./utils');



	//┐  UTILS
	//╠──⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙
	//┘

		const
			setPrototypeOf = Object.setPrototypeOf,
			assign = Object.assign,

			{ newObj, hasKey, isInt, isFunction } = Utils;



		// DEBUGGING
		// ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

			const { log, error, inspect } = Utils;



	//┐  DEFAULT OPTIONS
	//╠──⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙⁘⁙
	//┘

		const __options = newObj();

		__options.parallel = false;
		__options.limit = 0;

		__options.delay = 0;
		__options.interval = 0;

		__options.onRun = null;
		__options.onEnd = null;

		__options.queue = [];




//┐  CONSTRUCTOR
//╠──░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//┘


	function CombaList (options)
	{
		const
			opt = assign({}, __options, options || newObj()),
			ctx = newObj();



		// OPTIONS
		// ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

			ctx.parallel = opt.parallel;
			ctx.limit = opt.limit;

			ctx.delay = opt.delay;
			ctx.interval = opt.interval;



		// EVENT LISTENERS
		// ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

			ctx.listeners = newObj();
			ctx.listeners.run = opt.onRun;
			ctx.listeners.end = opt.onEnd;



		// QUEUE OF TASKS
		// ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

			ctx.queue = (opt.queue.length) ? Make(opt.queue) : opt.queue;



		// INSTANCE
		// ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

			ctx.instance = setPrototypeOf(onComplete => ctx.instance.run(onComplete), this);
			ctx.instance.constructor = CombaList;


		return __interface(ctx);
	}




//┐  INTERFACE
//╠──░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//┘


	function __interface (ctx)
	{

		const
			instance = ctx.instance,
			isParallel = ctx.parallel,
			listeners = ctx.listeners,
			queue = ctx.queue;



		// CHAINABLE METHODS
		// ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

			Object.defineProperties(instance,
			{

				// PARALLEL LIMIT
				// ─────────────────────────────────────────────────

					limit:
					{
						value: (value) =>
						{
							ctx.limit = (isParallel && isInt(value)) ? value : 0;

							return instance;
						}
					},


				// DELAY RUNNING
				// ─────────────────────────────────────────────────

					delay:
					{
						value: (value) =>
						{
							ctx.delay = (isInt(value)) ? value : 0;

							return instance;
						}
					},


				// INTERVAL EXECUTION
				// ─────────────────────────────────────────────────

					interval:
					{
						value: (value) =>
						{
							ctx.interval = (isInt(value)) ? value : 0;

							return instance;
						}
					},


				// APPEND TASKS
				// ─────────────────────────────────────────────────

					append:
					{
						value: (...values) =>
						{
							if (values.length) {
								queue.push(...Make(values));
							}

							return instance;
						}
					},


				// PREPEND TASKS
				// ─────────────────────────────────────────────────

					prepend:
					{
						value: (...values) =>
						{
							if (values.length) {
								queue.unshift(...Make(values));
							}

							return instance;
						}
					},


				// EVENT LISTENERS
				// ─────────────────────────────────────────────────

					on:
					{
						value: (event, handler) =>
						{
							if (isFunction(handler) && hasKey(listeners, event)) {
								listeners[event] = handler;
							}

							return instance;
						}
					}
			});



		// GETTERS
		// ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

			Object.defineProperties(instance,
			{

				// GET TASKS
				// ─────────────────────────────────────────────────

					tasks: { get: () => [...queue] }
			});



		// EXECUTION
		// ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

			Object.defineProperty(instance, 'run',
			{
				value: (callback) =>
				{
					if (!queue.length) {
						// error
					}

					new CombaMill(ctx, callback).exec();
				}
			});



		return instance;
	}




//┐  EXPORTS
//╠──░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//┘

	module.exports = CombaList;


